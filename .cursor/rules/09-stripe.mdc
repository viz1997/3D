---
description: Stripe setup and webhook handling
globs:
alwaysApply: false
---

- Use the singleton from `lib/stripe/index.ts`. Initialization is gated by `NEXT_PUBLIC_ENABLE_STRIPE === 'true'` and `STRIPE_SECRET_KEY`.
- Webhooks: Implement handlers in `app/api/stripe/webhook/route.ts` and dispatch to `app/api/stripe/webhook/webhook-handlers.ts`. Verify signature with `STRIPE_WEBHOOK_SECRET`.
- When creating portal sessions or checkout, derive domain/protocol from `headers()` as in `actions/stripe/index.ts`. Fallback to `NEXT_PUBLIC_SITE_URL`.
- Persist Stripe IDs in DB using Drizzle tables (`user.stripeCustomerId`, `subscriptions`, `orders`). Use `onConflictDoUpdate` for idempotency where relevant.
- Store and read `metadata.userId` and `metadata.planId` to connect Stripe objects back to local entities. Fallback to DB lookups by `stripeCustomerId` if metadata is missing.
- Email notifications: Use `sendInvoicePaymentFailedEmail`, `sendCreditUpgradeFailedEmail`, `sendFraudWarningAdminEmail`, and `sendFraudRefundUserEmail` from `actions/stripe/index.ts` with Resend when `RESEND_API_KEY` and `ADMIN_EMAIL` are configured.
- Env required: `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET`, `NEXT_PUBLIC_ENABLE_STRIPE`, `STRIPE_CUSTOMER_PORTAL_URL`.

Webhook Event Handlers (`app/api/stripe/webhook/webhook-handlers.ts`):
- `handleCheckoutSessionCompleted(session)` — Processes completed checkout sessions for both one-time payments and subscriptions. Creates order records and calls `upgradeOneTimeCredits` for one-time purchases.
- `handleInvoicePaid(invoice)` — Handles paid subscription invoices. Creates order records and calls `upgradeSubscriptionCredits`. Syncs subscription data.
- `handleSubscriptionUpdate(subscription, isDeleted)` — Syncs subscription updates and calls `revokeRemainingSubscriptionCreditsOnEnd` if subscription is deleted.
- `handleInvoicePaymentFailed(invoice)` — Syncs subscription state and sends payment failure notification emails.
- `handleRefund(charge)` — Processes refunds by creating refund order records. Calls `revokeOneTimeCredits` or `revokeSubscriptionCredits` based on order type.
- `handleEarlyFraudWarningCreated(warning)` — Handles fraud warnings based on `STRIPE_RADAR_EARLY_FRAUD_WARNING_TYPE` env variable (can be 'refund', 'email', or 'refund,email').
- All handlers use retry logic with exponential backoff for credit operations and maintain idempotency via DB checks.

Server Actions (`actions/stripe/index.ts`):
- `getOrCreateStripeCustomer(userId)` — Retrieves or creates Stripe customer and updates `user.stripeCustomerId` in DB.
- `createStripePortalSession()` — Creates Stripe billing portal session for authenticated users.
- `syncSubscriptionData(subscriptionId, customerId, initialMetadata?)` — Syncs Stripe subscription data to local `subscriptions` table with upsert logic.
- All email notification functions are exported from this file for use in webhook handlers.
